<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>共響 SHARING</title>

    <!-- jquery -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>

    <!-- JavaScript Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.bundle.min.js"></script>
    <!-- <link rel="stylesheet" href="css/bootstrap.min.css"> -->

    <!-- fontawesome -->
    <script src="https://kit.fontawesome.com/4de7eaf6aa.js" crossorigin="anonymous"></script>

    <!-- Theme style -->
    <link rel="stylesheet" href="AdminLTE3/dist/css/adminlte.min.css">
    <script src="AdminLTE3/dist/js/adminlte.min.js"></script>

    <!-- Chart.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.3/Chart.bundle.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.3/Chart.min.css" />

    <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/tom-select/2.4.1/css/tom-select.bootstrap4.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/tom-select/dist/js/tom-select.complete.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/quill@2.0.3/dist/quill.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/quill@2.0.3/dist/quill.snow.css" rel="stylesheet" />

    <!-- toastr -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.css" />

    <!-- datepicker -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.30.1/moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.css" />

    <!-- Cropper.js -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-cropper/1.0.2/jquery-cropper.min.js"></script>

    <!-- Vue.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vue/3.5.13/vue.global.min.js"></script>

    <script src="js/share.js"></script>
    <link rel="stylesheet" href="css/share.css" />

    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>

</head>

<body class="sidebar-mini layout-navbar-fixed layout-footer-fixed sidebar-mini-md layout-fixed sidebar-collapse">
    <!-- Preloader -->
    <div class="preloader flex-column justify-content-center align-items-center">
        <img class="animation__shake" src="img/logo.svg" style="height: 15vh;">
    </div>
    <!-- control-sidebar-slide-open -->
    <div id="app" class="wrapper">
        <div class="modal fade" id="cropModal" tabindex="-1" role="dialog" data-backdrop="static" 和
            data-keyboard="false">
            <div class="modal-dialog modal-xl modal-dialog-scrollable modal-dialog-centered" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">裁剪圖片</h5>
                        <button type="button" class="close" data-dismiss="modal">&times;</button>
                    </div>
                    <div class="modal-body text-center">
                        <div class="img-container">
                            <img id="image" ref="image" class="img-fluid">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-primary" @click="cropImage_logo"
                            v-if="imageAction=='logo'">確定裁剪爲Logo</button>
                        <button class="btn btn-primary" @click="cropImage_banner"
                            v-if="imageAction=='banner'">確定裁剪爲橫幅</button>
                    </div>
                </div>
            </div>
        </div>
        <!-- Navbar -->
        <nav class="main-header navbar navbar-expand navbar-white navbar-light">
            <!-- Left navbar links -->
            <ul class="navbar-nav d-md-none">
                <li class="nav-item">
                    <a class="nav-link" data-widget="pushmenu" href="#" role="button"><i class="fas fa-bars"></i></a>
                </li>
            </ul>

            <!-- Right navbar links -->
            <ul class="navbar-nav ml-auto">
                <li class="nav-item dropdown">
                    <a class="nav-link" data-toggle="dropdown" href="#">
                        <i class="fas fa-store" id="OpenStatus"></i>
                        {{storeInfo.store.storeName}}
                        <i class="fas fa-caret-down"></i>
                    </a>
                    <div class="dropdown-menu dropdown-menu-lg dropdown-menu-right overflow-auto StoreSelector">
                        <a class="dropdown-item" v-for="(store,index) in allStore" :id="store.storeId"
                            onclick="itemClick($(this))">
                            <div class="store">
                                <strong>{{ store.storeName }}</strong>
                                <p class="text-muted">{{ store.city }}{{ store.districts }}{{ store.shortAddress }}</p>
                            </div>
                        </a>
                    </div>
                </li>
            </ul>
        </nav>
        <!-- /.navbar -->

        <!-- Main Sidebar Container -->
        <aside class="main-sidebar elevation-4 sidebar-light-primary">
            <!-- Brand Logo -->
            <a class="toIndex brand-link logo-switch">
                <img src="img/logo.svg" alt="AdminLTE Docs Logo Small" class="brand-image-xl logo-xs">
                <img src="img/logo2.svg" alt="AdminLTE Docs Logo Large" class="brand-image-xs logo-xl"
                    style="width: 200px;">
            </a>


            <!-- Sidebar -->
            <div class="sidebar os-theme-dark">
                <!-- Sidebar user (optional) -->
                <div class="user-panel mt-3 pb-3 mb-3 d-flex">
                    <div class="image">
                        <img src="img/user.png" class="img-circle elevation-2" alt="User Image">
                    </div>
                    <div class="info">
                        <p href="#" class="d-inline-block m-0 mr-5">Hi {{userInfo.name}}</p>
                        <button class="btn btn-sm m-0 toEditAccount">
                            <i class="fas fa-user-edit"></i>
                        </button>
                        <button class="btn btn-sm m-0 toLogin">
                            <i class="fas fa-sign-out-alt"></i>
                        </button>
                    </div>
                </div>
                <!-- Sidebar Menu -->
                <nav class="mt-2">
                    <ul class="nav nav-pills nav-sidebar flex-column nav-child-indent" data-widget="treeview"
                        role="menu" data-accordion="false">
                        <!-- Add icons to the links using the .nav-icon class
                         <br /> with font-awesome or any other icon font library -->
                        <li class="nav-item" v-for="(fuc,index) in userFunction">
                            <a :href="fuc.url" class="nav-link" :class="{'active':fuc.status==true}">
                                <i class="nav-icon" :class="fuc.icon"></i>
                                <p>
                                    {{fuc.name}}
                                    <i class="fas fa-angle-left right" v-if="fuc.item!=null"></i>
                                </p>
                            </a>
                            <ul class="nav nav-treeview" v-if="fuc.item!=null">
                                <li class="nav-item" v-for="(fucItem,index) in fuc.item" :key="index">
                                    <a :href="fucItem.url" class="nav-link" :class="{'active':fuc.status==true}">
                                        <i class="nav-icon" :class="fucItem.icon"></i>
                                        <p>{{fucItem.name}}</p>
                                    </a>
                                </li>
                            </ul>
                        </li>

                    </ul>
                </nav>
                <!-- /.sidebar-menu -->
            </div>
            <!-- /.sidebar -->
        </aside>

        <!-- Content Wrapper. Contains page content -->
        <div class="content-wrapper">
            <!-- Content Header (Page header) -->
            <div class="content-header">
                <div class="container-fluid">
                    <div class="row mb-2">
                        <div class="col-sm-6">
                            <h1 class="m-0">{{PageTitle}}</h1>
                        </div><!-- /.col -->
                        <div class="col-sm-6">
                            <ol class="breadcrumb float-sm-right">
                                <li class="breadcrumb-item"><a class="toIndex">SHARING</a></li>
                                <li class="breadcrumb-item active">{{PageTitle}}</li>
                            </ol>
                        </div><!-- /.col -->
                    </div><!-- /.row -->
                </div><!-- /.container-fluid -->
            </div>
            <!-- /.content-header -->

            <!-- Main content -->
            <div class="content">
                <div class="container-fluid">
                    <div class="row">
                        <div class="col-12 col-md-8">
                            <div class="accordion" id="accordion">
                                <div class="card m-0" v-for="(item, index) in StoreEditItem" :key="item.id">
                                    <a class="d-block w-100 collapsed" data-toggle="collapse" :href="'#'+item.id"
                                        aria-expanded="false">
                                        <div class="card-header">
                                            <h6 class="w-100 m-0">
                                                <span v-html="item.name"></span>
                                                <span class="" v-show="item.editDone">*</span>
                                                <span class="text-danger ml-2" v-show="item.editError">
                                                    <i class="fas fa-exclamation-circle"></i></span>
                                            </h6>
                                            <!-- <p class="text-muted m-0 ml-4">
                                                {{item.discriptions}}
                                            </p> -->
                                        </div>
                                    </a>
                                    <div :id="item.id" class="collapse" data-parent="#accordion" style="">
                                        <div class="card-body py-2 px-3">
                                            <div class="mb-3" v-for="(settingItem, index) in item.settingItem"
                                                :key="index">
                                                <p class="m-0">
                                                    {{ settingItem.name }}
                                                    <span class="text-muted text-sm"
                                                        v-if="settingItem.groupitem.type === 'BannerImage'||settingItem.groupitem.type === 'LogoImage'">(點擊圖片更換)</span>
                                                </p>
                                                <!-- 店家地址 -->
                                                <div class="col-12 my-1"
                                                    v-if="settingItem.groupitem.type === 'address'">
                                                    <div class="input-group mb-1">
                                                        <select class="form-control"
                                                            :disabled="!settingItem.groupitem.enabled"
                                                            v-model="storeInfoEdit.storeInfo.city">
                                                            <option v-for="(city, index) in allCity" :key="index"
                                                                :value="city.name">
                                                                {{ city.name }}
                                                            </option>
                                                        </select>
                                                        <select class="form-control"
                                                            :disabled="!settingItem.groupitem.enabled"
                                                            v-model="storeInfoEdit.storeInfo.districts">
                                                            <option v-for="(district, index) in allDistricts"
                                                                :key="index" :value="district.name">
                                                                {{ district.name }}
                                                            </option>
                                                        </select>
                                                    </div>
                                                    <input class="form-control" autocomplete="off"
                                                        :disabled="!settingItem.groupitem.enabled"
                                                        v-model="storeInfoEdit.storeInfo.shortAddress"
                                                        :placeholder="settingItem.groupitem.placeholder">
                                                </div>

                                                <!-- logo -->
                                                <div class="col-12 my-1"
                                                    v-if="settingItem.groupitem.type === 'LogoImage'">
                                                    <div class="input-group mb-1">
                                                        <label
                                                            class="embed-responsive embed-responsive-1by1 d-flex justify-content-center"
                                                            style="overflow: hidden;max-width: 300px;">

                                                            <img :src="storeInfoEdit.store.image || 'img/unknowIMG.png'"
                                                                class="border h-100">

                                                            <input type="file" class="custom-file-input" id="LogoImage"
                                                                @change="handleFileUpload_logo"
                                                                accept=".jpg,.jpeg,.png">

                                                        </label>
                                                    </div>
                                                </div>

                                                <!-- Banner -->
                                                <div class="col-12 my-1"
                                                    v-if="settingItem.groupitem.type === 'BannerImage'">
                                                    <div class="input-group mb-1">
                                                        <label
                                                            class="embed-responsive embed-responsive-16by9 d-flex justify-content-center"
                                                            style="overflow: hidden">

                                                            <img :src="storeInfoEdit.store.bannerimage || 'img/unknowIMG.png'"
                                                                class="border w-100">

                                                            <input type="file" class="custom-file-input"
                                                                id="BannerImage" @change="handleFileUpload_banner"
                                                                accept=".jpg,.jpeg,.png">

                                                        </label>
                                                    </div>
                                                </div>

                                                <!-- 店家信箱 -->
                                                <div class="col-12 my-1" v-if="settingItem.groupitem.type === 'email'">
                                                    <input class="form-control" type="email" autocomplete="off"
                                                        :disabled="!settingItem.groupitem.enabled"
                                                        v-model="storeInfoEdit.storeInfo.email"
                                                        :class="{'is-invalid': !validateEmail(storeInfoEdit.storeInfo.email)}"
                                                        :placeholder="settingItem.groupitem.placeholder">
                                                    <div class="text-memo text-danger"
                                                        v-if="!validateEmail(storeInfoEdit.storeInfo.email)">
                                                        *請輸入正確的Email格式
                                                    </div>
                                                </div>

                                                <!-- 店家電話 -->
                                                <div class="col-12 my-1" v-if="settingItem.groupitem.type === 'tel'">
                                                    <input class="form-control" type="tel" autocomplete="off"
                                                        :disabled="!settingItem.groupitem.enabled"
                                                        v-model="storeInfoEdit.storeInfo.tel"
                                                        :class="{'is-invalid': !validateTalAndPhone(this.storeInfoEdit.storeInfo.tel)}"
                                                        :placeholder="settingItem.groupitem.placeholder">
                                                    <div class="text-memo text-danger"
                                                        v-if="!validateTalAndPhone(storeInfoEdit.storeInfo.tel)">
                                                        *請輸入正確的市話或手機格式
                                                    </div>
                                                </div>

                                                <!-- 店家簡介 -->
                                                <div class="col-12 my-1"
                                                    v-if="settingItem.groupitem.type === 'text editor'">
                                                    <div class="form-control" id="storeIntroduction"
                                                        :disabled="!settingItem.groupitem.enabled"></div>
                                                </div>

                                                <!-- 店家名稱 -->
                                                <div class="col-12 my-1"
                                                    v-if="settingItem.groupitem.type === 'storeName'">
                                                    <input class="form-control" type="tel" autocomplete="off"
                                                        :disabled="!settingItem.groupitem.enabled"
                                                        v-model="storeInfoEdit.store.storeName"
                                                        :placeholder="settingItem.groupitem.placeholder">
                                                </div>

                                                <!-- 統一編號 -->
                                                <div class="col-12 my-1"
                                                    v-if="settingItem.groupitem.type === 'businessNum'">
                                                    <input class="form-control" type="tel" autocomplete="off"
                                                        :disabled="!settingItem.groupitem.enabled"
                                                        v-model="storeInfoEdit.storeInfo.businessNum"
                                                        :class="{'is-invalid': storeInfoEdit.storeInfo.businessNum.length!=8}"
                                                        :placeholder="settingItem.groupitem.placeholder">
                                                    <div class="text-memo text-danger"
                                                        v-if="storeInfoEdit.storeInfo.businessNum.length!=8">
                                                        *統一編號格式須為8碼數字
                                                    </div>
                                                </div>

                                                <!-- 標籤 -->
                                                <div class="col-12 my-1"
                                                    v-if="settingItem.groupitem.type === 'KeyWord Tag'">
                                                    <input class="form-control" id="input-tags" autocomplete="off"
                                                        :placeholder="settingItem.groupitem.placeholder"
                                                        v-model="storeInfoEdit.storeInfo.tags"
                                                        :disabled="!settingItem.groupitem.enabled">
                                                </div>

                                                <!-- 營業時間 -->
                                                <div class="col-12 my-1"
                                                    v-if="settingItem.groupitem.type === 'BusinessTime'">
                                                    <div class="row m-0 py-3 border-bottom"
                                                        v-for="(day,index) in storeInfoEdit.openTime.businessDays">
                                                        <div class="col m-0">
                                                            {{day.title}}
                                                        </div>
                                                        <div class="custom-control custom-switch">
                                                            <input type="checkbox" class="custom-control-input"
                                                                :id="'operation'+day.id" v-model="day.operation"
                                                                @change="toggleOperation(day.id, day.operation)">
                                                            <label class="custom-control-label text-success m-0 ml-2"
                                                                v-if="day.operation" :for="'operation'+day.id">
                                                                營業
                                                            </label>
                                                            <label class="custom-control-label text-danger m-0 ml-2"
                                                                v-if="!day.operation" :for="'operation'+day.id">
                                                                休息
                                                            </label>
                                                        </div>
                                                        <div v-if="day.operation" class="col-12 m-0">
                                                            <div class="row">
                                                                <div class="col-12 mt-3">
                                                                    <div class="input-group mb-2"
                                                                        v-for="(time,index) in day.time">
                                                                        <input class="form-control" v-model="time.open"
                                                                            type="time" :data-for="'open-'+day.id">
                                                                        <span class="mx-2">~</span>
                                                                        <input class="form-control" v-model="time.close"
                                                                            type="time" :data-for="'close-'+day.id">
                                                                        <div class="input-group-append">
                                                                            <button
                                                                                v-on:click="deletOperationTime(day.id,index)"
                                                                                class="btn btn-outline-secondary">
                                                                                <i class="fas fa-trash-alt"></i>
                                                                            </button>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                                <div class="col-12">
                                                                    <button class="btn-link btn btn-sm"
                                                                        v-show="3>day.time.length" :data-for="index"
                                                                        v-on:click="addOperationTime(index)">
                                                                        + 新增營業區間
                                                                    </button>
                                                                </div>
                                                            </div>

                                                        </div>

                                                    </div>
                                                </div>

                                                <!-- 間隔等待時間 -->
                                                <div class="col-12 my-1"
                                                    v-if="settingItem.groupitem.type === 'IntervalTime'">
                                                    <input class="form-control w-25 d-inline-block" autocomplete="off"
                                                        :class="{'is-invalid':!validateIntervalTime(storeInfoEdit.store.orderInterval, 5)}"
                                                        :disabled="!settingItem.groupitem.enabled" type="number"
                                                        v-model="storeInfoEdit.store.orderInterval" min="0" max="60"
                                                        step="5">
                                                    <p class="pl-3 w-25 d-inline-block m-0 mr-5">分鐘</p>
                                                    <div class="text-memo text-danger"
                                                        v-if="!validateIntervalTime(storeInfoEdit.store.orderInterval, 5)">
                                                        *間隔時間須為5的倍數
                                                    </div>
                                                </div>

                                                <!-- 基礎等待時間 -->
                                                <div class="col-12 my-1"
                                                    v-if="settingItem.groupitem.type === 'BasicTime'">
                                                    <select class="form-control w-25 d-inline-block" autocomplete="off"
                                                        :disabled="!settingItem.groupitem.enabled"
                                                        v-model="storeInfoEdit.storeInfo.basicwaitingTime">
                                                        <option v-for="num in generateNumbers(0, 60, 5)" :key="num"
                                                            :value="num">
                                                            {{ num }}
                                                        </option>
                                                    </select>
                                                    <p class="pl-3 w-25 d-inline-block m-0 mr-5">分鐘</p>
                                                </div>

                                                <!-- 最低金額 -->
                                                <div class="col-12 my-1"
                                                    v-if="settingItem.groupitem.type === 'minPrice'">
                                                    <p class="text-muted text-sm">若消費者下單總金額低於設定值，該訂單不成立並跳出警告訊息</p>
                                                    <input class="form-control w-25" type="number" min="0"
                                                        v-model="storeInfoEdit.storeInfo.minimumOrderAmount"
                                                        ref="inputs">
                                                </div>

                                                <!-- 最低單數 -->
                                                <div class="col-12 my-1"
                                                    v-if="settingItem.groupitem.type === 'MinOrderCount'">
                                                    <input class="form-control w-25" type="number" min="0"
                                                        v-model="storeInfoEdit.store.amountLimit">
                                                </div>

                                                <!-- 最高金額 -->
                                                <div class="col-12 my-1"
                                                    v-if="settingItem.groupitem.type === 'maxPrice'">
                                                    <input class="form-control w-25" type="number" min="0"
                                                        v-model="storeInfoEdit.store.slotLimit" ref="inputs">
                                                </div>

                                                <!-- 低消提示 -->
                                                <div class="col-12 my-1"
                                                    v-if="settingItem.groupitem.type === 'Reminder'">
                                                    <div class="custom-control custom-switch">
                                                        <input type="checkbox" class="custom-control-input"
                                                            id="minimumOrderReminder"
                                                            v-model="storeInfoEdit.storeInfo.minimumOrderEnabled">
                                                        <label class="custom-control-label text-success m-0 ml-2"
                                                            for="minimumOrderReminder"
                                                            v-if="storeInfoEdit.storeInfo.minimumOrderEnabled">
                                                            開啟
                                                        </label>
                                                        <label class="custom-control-label text-danger m-0 ml-2"
                                                            for="minimumOrderReminder"
                                                            v-if="!storeInfoEdit.storeInfo.minimumOrderEnabled">
                                                            關閉
                                                        </label>
                                                    </div>
                                                    <!-- 低消金額 -->
                                                    <!-- <div class="col-12 py-3"
                                                            v-if="storeInfoEdit.minimumOrderEnabled==true">
                                                            <div class="p-3">
                                                                <h6>低消金額</h6>
                                                                <p class="pr-3 w-auto d-inline-block m-0 text-end">
                                                                    $
                                                                </p>
                                                                <input class="form-control w-auto d-inline-block"
                                                                    autocomplete="off" min="0" placeholder="低消金額，EX:100"
                                                                    :disabled="!settingItem.groupitem.enabled"
                                                                    type="number"
                                                                    v-model="storeInfoEdit.storeInfo.minimumOrderReminder.minimumOrder">
                                                            </div> -->

                                                    <!-- 提示內容 -->
                                                    <div class="p-3">
                                                        <h6>警告提示</h6>
                                                        <textarea class="form-control" placeholder='提示內容文字，EX:未達最低消費金額'
                                                            v-model="storeInfoEdit.storeInfo.minimumOrderText"></textarea>
                                                    </div>
                                                </div>


                                                <!-- 店休 -->
                                                <div class="col-12 my-1"
                                                    v-if="settingItem.groupitem.type === 'StoreClosed'">
                                                    <div class="row mt-3">
                                                        <div class="col-12"
                                                            v-for="(day,index) in storeInfoEdit.openTime.specialCloseDays">
                                                            <div class="input-group mb-2" v-if="day.date>today">
                                                                <!-- <div class="input-group mb-2"> -->
                                                                <input type="text" class="form-control"
                                                                    v-model="day.title"
                                                                    :placeholder="settingItem.groupitem.placeholder">
                                                                <input type="date" class="form-control"
                                                                    :class="{'is-invalid': today > day.date}"
                                                                    v-model="day.date" :min="today">
                                                                <div class="input-group-append">
                                                                    <button class="btn btn-outline-secondary"
                                                                        @click="delStoreClosed(index)" type="button">
                                                                        <i class="fas fa-trash-alt"
                                                                            aria-hidden="true"></i>
                                                                    </button>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <button class="btn-link btn btn-sm" @click="addStoreClosed">
                                                            + 特殊店休日期
                                                        </button>
                                                    </div>
                                                </div>

                                                <!-- 最多可預訂天數 -->
                                                <div class="col-12 my-1"
                                                    v-if="settingItem.groupitem.type === 'maxReservationDays'">
                                                    <input class="form-control w-25 d-inline-block" type="number"
                                                        autocomplete="off" :disabled="!settingItem.groupitem.enabled"
                                                        v-model="storeInfoEdit.storeInfo.maxReservationDays" min="0"
                                                        :placeholder="settingItem.groupitem.placeholder">
                                                    <p class="pl-3 w-25 d-inline-block m-0 mr-5">天</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="p-3 text-end col-12 border-top mt-3" id="saveBar">
                            <button class="btn btn-secondary mr-2" v-on:click="reset">
                                <i class="fas fa-save mr-2"></i>恢復原資料
                            </button>

                            <button class="btn btn-primary" v-on:click="save">
                                <i class="fas fa-save mr-2"></i>保存
                            </button>
                        </div>
                    </div>

                </div>
                <!-- /.row -->
            </div><!-- /.container-fluid -->
        </div>
        <!-- /.content -->
    </div>
    <!-- /.content-wrapper -->

    <!-- Main Footer -->
    <footer class="main-footer">
        <!-- To the right -->
        <div class="float-right d-none d-sm-inline" id="version"></div>
        <!-- Default to the left -->
        <strong id="copyRight"></strong>
    </footer>
    </div>
    <!-- ./wrapper -->

    <!-- REQUIRED SCRIPTS -->
</body>
<script src="js/TwCities.js"></script>
<script>
    checkUserInfo()

    const app = Vue.createApp({
        data() {
            return {
                userFunction: userFunction,

                PageTitle: '店家管理',


                //原始資料
                userInfo: decryptObject(localStorage.userInfo),
                storeInfo: decryptObject(localStorage.storeInfo),
                allStore: decryptObject(localStorage.allStore),

                //編輯資料
                storeInfoEdit: {
                    "store": {
                        "storeId": "",
                        "storeName": "",
                        "storePhone": "",
                        "minOrderAmount": 0,
                        "orderInterval": 0,
                        "createdDate": "",
                        "enable": true,
                        "deleted": false,
                        "id": 0,
                        "slotLimit": 0,
                        "amountLimit": 0
                    },
                    "storeInfo": {
                        "storeId": "",
                        "city": "",
                        "districts": "",
                        "shortAddress": "",
                        "email": "",
                        "tel": "",
                        "businessNum": "",
                        "introduction": "",
                        "tags": [
                            "中式料理",
                            "家常菜",
                            "快速出餐"
                        ],
                        "basicwaitingTime": "",
                        "minimumOrderAmount": "",
                        "minimumOrderText": "",
                        "minimumOrderEnabled": true,
                        "maxReservationDays": 0
                    },
                    "openTime": {
                        "businessDays": [

                        ],
                        "specialCloseDays": [

                        ]
                    }
                },

                allCity: [],
                allDistricts: [],

                StoreEditItem: [
                    {
                        id: 'StoreInfo',
                        name: '<i class="fas fa-store mr-2"></i>店家資訊',
                        discriptions: '店家基本資訊，圖片、地址、電話...',
                        settingItem: [
                            {
                                name: '店家名稱',
                                groupitem:
                                {
                                    type: 'storeName',
                                    enabled: false,
                                    placeholder: ""
                                }

                            },
                            {
                                name: 'LOGO圖片',
                                groupitem:
                                {
                                    type: 'LogoImage',
                                    enabled: true,
                                    placeholder: ""
                                },
                            },
                            {
                                name: '橫幅圖片',
                                groupitem:
                                {
                                    type: 'BannerImage',
                                    enabled: true,
                                    placeholder: ""
                                },
                            },
                            {
                                name: '店家地址',
                                groupitem:
                                {
                                    type: 'address',
                                    enabled: true,
                                    placeholder: ""
                                },
                                checkFunc: this.address
                            },
                            {
                                name: 'E-Mail',
                                groupitem:
                                {
                                    type: 'email',
                                    enabled: true,
                                    placeholder: ""
                                }

                            },
                            {
                                name: '店家電話',
                                groupitem:
                                {
                                    type: 'tel',
                                    enabled: true,
                                    placeholder: ""
                                }

                            },
                            {
                                name: '店家簡介',
                                groupitem:
                                {
                                    type: 'text editor',
                                    enabled: true,
                                    placeholder: ""
                                }

                            },
                            {
                                name: '統一編號',
                                groupitem:
                                {
                                    type: 'businessNum',
                                    enabled: true,
                                    placeholder: "",
                                }

                            },
                            {
                                name: '標籤',
                                groupitem:
                                {
                                    type: 'KeyWord Tag',
                                    enabled: false,
                                    placeholder: ""
                                }

                            },
                        ],
                        editDone: false,
                        editError: false
                    },
                    {
                        id: 'BusinessTime',
                        name: '<i class="fas fa-coffee mr-2"></i>營業時間設定',
                        discriptions: '正常營業時間設定',
                        settingItem: [
                            {
                                name: '',
                                groupitem:
                                {
                                    type: 'BusinessTime',
                                    enabled: true,
                                    placeholder: ""
                                }

                            },
                        ],
                        editDone: false,
                        editError: false,
                        checkUndone: false
                    },
                    {
                        id: 'WaitingTime',
                        name: '<i class="fas fa-clock mr-2"></i>取餐等待時間',
                        discriptions: '用於計算取餐等待時間的設定',
                        settingItem: [
                            {
                                name: '基礎時間',
                                groupitem:
                                {
                                    type: 'BasicTime',
                                    enabled: true,
                                    placeholder: "",
                                }

                            },
                            {
                                name: '間隔時間',
                                groupitem:
                                {
                                    type: 'IntervalTime',
                                    enabled: true,
                                    placeholder: "",
                                }

                            },
                            {
                                name: '最低單數',
                                groupitem:
                                {
                                    type: 'MinOrderCount',
                                    enabled: true,
                                    placeholder: "",
                                }

                            },
                            {
                                name: '最高金額',
                                groupitem:
                                {
                                    type: 'maxPrice',
                                    enabled: true,
                                    placeholder: "",
                                }

                            },
                            {
                                name: '最多可預訂天數',
                                groupitem:
                                {
                                    type: 'maxReservationDays',
                                    enabled: true,
                                    placeholder: "可預訂天數，EX:0",
                                }

                            }
                        ],
                        editDone: false,
                        editError: false,
                        checkUndone: false
                    },
                    {
                        id: 'ReminderToggle',
                        name: '<i class="fas fa-bell mr-2"></i>低消提醒功能',
                        discriptions: '訂單低消提醒設定',
                        settingItem: [
                            {
                                name: '低消金額',
                                groupitem:
                                {
                                    type: 'minPrice',
                                    enabled: true,
                                    placeholder: "",
                                }

                            }
                            ,
                            {
                                name: '低消提示',
                                groupitem:
                                {
                                    type: 'Reminder',
                                    enabled: true,
                                    placeholder: "",
                                }

                            }
                        ],
                        editDone: false,
                        editError: false,
                        checkUndone: false
                    },
                    {
                        id: 'StoreClosed',
                        name: '<i class="fas fa-bed mr-2"></i>特定店休日',
                        discriptions: '公休外的店休，EX:國定假日...自由新增',
                        settingItem: [
                            {
                                name: '店休日期',
                                groupitem:
                                {
                                    type: 'StoreClosed',
                                    enabled: true,
                                    placeholder: "店休名稱，EX:端午節",
                                }

                            }
                        ],
                        editDone: false,
                        editError: false,
                        checkUndone: false
                    }
                ],

                LogoImageSize: { w: 300, h: 300 },
                BannerImageSize: { w: 1920, h: 1080 },
                imageAction: '',
            }
        },
        mounted() {

            // 初始資料載入
            this.initCityData();
            this.setDistricts();

            this.GetStoreInfo()

            //tag標籤
            new TomSelect("#input-tags", {
                persist: false,
                createOnBlur: true,
                create: true,
                items: this.storeInfoEdit.storeInfo.tags,
            });

            // console.log(this.storeInfoEdit);



            this.$nextTick(() => {
                this.$refs.inputs.forEach(input => {
                    input.addEventListener("input", function () {
                        if (this.value < 0) {
                            this.value = 0;
                        }
                    })
                })
            })

            // this.CanSave('default-')
        },
        watch: {
            // //編輯資料時檢查資料並disabled/enabled SaveBtn
            // storeInfoEdit: {
            //     handler(newVal, oldVal) {
            //         //取得各大區塊檢查結果
            //         const isStoreInfoValid = this.StoreInfoCheck();
            //         const isBusinessTimeValid = this.BusinessTime();
            //         const isWaitingTimeValid = this.WaitingTime();
            //         const isMinimumOrderReminderValid = this.minimumOrderReminder();
            //         const isStoreClosedValid = this.storeClosed();
            //         const isAdvanceReservationValid = this.advanceReservation();

            //         this.CanSave('handler-')
            //     },
            //     deep: true // 深度監控物件的內部屬性
            // },
            'storeInfoEdit.storeInfo.city'(newVal) {
                this.setDistricts()
            },
            'storeInfoEdit.openTime.businessDays'(newVal, oldVal) {

            }


        },
        methods: {
            //比對信箱格式
            validateEmail(par) {
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                return emailRegex.test(par); // 如果格式不正確，顯示錯誤
            },

            //比對電話格式
            validateTalAndPhone(par) {
                const landlineRegex = /^0[2-8]-?\d{6,8}$/; // 市內電話（含 "-" 可選）
                const mobileRegex = /^09\d{8}$/; // 手機號碼（09 開頭 + 8 位數）

                return landlineRegex.test(par) || mobileRegex.test(par);
            },

            //比對間隔時間
            validateIntervalTime(par, intt) {
                return par != '' && par % intt === 0
            },

            // 初始化縣市資料
            initCityData() {
                // 這裡把TWCity中的縣市資料填充到allCity
                this.allCity = TWCity.map(city => ({
                    name: city.name,
                    value: city.name
                }));
            },

            //帶入鄉鎮區的資料
            setDistricts() {
                // console.log(this.storeInfoEdit.storeInfo.city);

                const selectedCityData = TWCity.find(city => city.name === this.storeInfoEdit.storeInfo.city);
                // console.log(selectedCityData);


                if (selectedCityData) {
                    this.allDistricts = selectedCityData.districts.map(district => ({
                        name: district.name,
                        value: district.name
                    }));
                } else {
                    this.allDistricts = [];
                }
            },

            //使用者操作func
            //增加營業時間
            addOperationTime(k) {

                this.storeInfoEdit.openTime.businessDays[k].time.push(
                    { open: '00:00', close: '00:00' }
                )
                console.log(this.storeInfoEdit.openTime.businessDays[k].time)
            },

            //增加營業時間
            addStoreClosed() {
                this.storeInfoEdit.openTime.specialCloseDays.push(
                    {
                        title: '',
                        date: moment().subtract(-1, "days").format('YYYY-MM-DD'),
                    }
                )
            },

            //刪除營業時間
            deletOperationTime(id, index) {
                // 找到 id 為 "Mon" 的項目
                console.log(this.storeInfoEdit.openTime);

                const targetDay = this.storeInfoEdit.openTime.businessDays.find(day => day.id === id);
                targetDay.time.splice(index, 1);

                if (targetDay.time.length == 0) {
                    targetDay.operation = false
                }
            },

            delStoreClosed(index) {
                this.storeInfoEdit.openTime.specialCloseDays.splice(index, 1);
            },

            //切換營業或休息，清空資料
            toggleOperation(id, newValue) {
                // 找到對應的 day
                const targetDay = this.storeInfoEdit.openTime.businessDays.find(day => day.id === id);

                if (newValue) {
                    // 如果改為 true，並且 time 為空，加入一筆默認時間
                    if (targetDay.time.length === 0) {
                        targetDay.time.push({ open: '00:00', close: '00:00' });
                    }
                } else {
                    // 如果改為 false，清空 time
                    targetDay.time = [];
                }
            },

            //分鐘設定
            generateNumbers(start, end, step) {
                const numbers = [];
                for (let i = start; i <= end; i += step) {
                    numbers.push(i);
                }
                return numbers;
            },

            GetStoreInfo() {
                var vue = this
                apiWeb("api/Store/detail/" + storeId, "GET", null, "取得店家編輯資料", function (v) {
                    // console.log(v);
                    vue.storeInfoEdit = v;

                    //文字編輯器
                    var quill = new Quill('#storeIntroduction', {
                        theme: 'snow', // 使用雪花主題
                        placeholder: '請輸入店家簡介...', // 設定 placeholder
                        modules: {
                            toolbar: [
                                [{ 'size': ['small', 'medium', 'large', 'huge'] }],
                                [{ 'list': 'ordered' }, { 'list': 'bullet' }],
                                [{ 'align': [] }],
                                ['bold', 'italic', 'underline', 'strike'],
                                [{ 'color': [] }, { 'background': [] }],
                                ['link', 'image'],
                            ] // 設定工具列
                        }
                    });
                    // 自動帶入 storeInfo.introduction 的值
                    quill.root.innerHTML = vue.storeInfoEdit.storeInfo.introduction;

                    // 監聽內容變更
                    quill.on('text-change', () => {
                        vue.storeInfoEdit.storeInfo.introduction = quill.root.innerHTML;  // 存儲HTML內容
                        // 或者如果需要純文字：
                        // this.storeInfoEdit.introduction = quill.getText();  // 存儲純文字
                    });
                    loadingOff()
                });
            },

            //儲存
            save() {
                loadingOn();
                // console.log('this.storeInfoEdit.storeInfo.image-----' + this.storeInfoEdit.storeInfo.image);
                var vue = this

                var store = this.storeInfoEdit.store
                var storeInfo = this.storeInfoEdit.storeInfo

                var EditData = {
                    // store:{
                    // "StoreName": "測試商店",
                    // "StorePhone": store.storePhone,
                    "MinOrderAmount": store.minOrderAmount,
                    "OrderInterval": store.orderInterval,
                    "Bannerimage": store.bannerimage,
                    "Image": store.image,

                    // "LineToken": "abcdef123456789",
                    // "Enable": true,
                    "SlotLimit": store.slotLimit,
                    // }
                    'amountLimit': store.amountLimit,
                    //storeInfo:{
                    "City": storeInfo.city,
                    "Districts": storeInfo.districts,
                    "ShortAddress": storeInfo.shortAddress,
                    "Email": storeInfo.email,
                    "Tel": storeInfo.tel,
                    "BusinessNum": storeInfo.businessNum,
                    "Introduction": storeInfo.introduction,
                    // "Tags": "中式料理,家常菜,快速出餐",
                    // "AdvanceReservation": storeInfo.advanceReservation,
                    "BasicwaitingTime": storeInfo.basicwaitingTime,
                    "MinimumOrderAmount": storeInfo.minimumOrderAmount,
                    "MinimumOrderText": storeInfo.minimumOrderText,
                    "MinimumOrderEnabled": storeInfo.minimumOrderEnabled,
                    "MaxReservationDays": storeInfo.maxReservationDays
                    // }
                }

                // console.log(EditData);



                var aopenTime = {
                    StoreId: storeId,
                    BusinessDays: this.storeInfoEdit.openTime.businessDays,
                    SpecialCloseDays: this.storeInfoEdit.openTime.specialCloseDays
                }
                console.log(aopenTime);
                apiWeb('api/Store/EditStore/' + storeId, 'PATCH', JSON.stringify(EditData), '保存商店資訊-基本資訊', function (v) {
                    if (v.message == '商店信息更新成功') {
                        apiWeb('api/Store/open/time', 'POST', JSON.stringify(aopenTime), '保存商店資訊-營業時間', function (v) {
                            if (v.message == "Store open time updated successfully") {
                                // localStorage.storeInfo = encryptObject(vue.storeInfoEdit);
                                // window.location.href = 'StoreMaintain.html?sid=' + storeId
                                location.reload()
                            } else {
                                toastr.error("商店信息更新失敗");
                                loadingOff();
                            }
                        })
                    } else {
                        toastr.error("商店信息更新失敗");
                        loadingOff();
                    }
                })

            },

            //重置
            reset() {
                this.storeInfoEdit = this.storeInfo
                toastr.success("已恢復原資料");
            },

            //能否重製或儲存
            CanSave(name) {
                console.log(name + "變更檢查結果:", this.hasChanges(this.storeInfo, this.storeInfoEdit) + ' : ' + 'this.storeInfo = ' + JSON.stringify(this.storeInfo) + ' , ' + 'this.storeInfo = ' + JSON.stringify(this.storeInfoEdit));

                // return !this.hasChanges(this.storeInfo, this.storeInfoEdit);
            },

            hasChanges(original, edited) {
                return Object.keys(original).some(key => {
                    // 確保 `edited` 也有相同的 key，避免 `undefined`
                    if (!(key in edited)) return true;

                    // 避免物件遞迴錯誤
                    if (typeof original[key] === "object" && original[key] !== null) {
                        return this.hasChanges(original[key], edited[key]); // 加上 `this.`
                    }

                    // 修正數字類型比對
                    const originalValue = isNaN(original[key]) ? original[key] : Number(original[key]);
                    const editedValue = isNaN(edited[key]) ? edited[key] : Number(edited[key]);

                    return originalValue !== editedValue;
                });
            },

            //**判斷資料是否被編輯（有其中一個項目被編輯：true）
            //=================
            //-------大區塊：店家資訊-------
            StoreInfoCheck() {
                const CheckItem = this.StoreEditItem.find(item => item.id === 'StoreInfo');
                if (!CheckItem) return false; // 確保 CheckItem 存在，否則回傳 false

                // 檢查錯誤條件
                const checksError = [
                    this.validateEmail(this.storeInfoEdit.email),
                    this.validateTalAndPhone(this.storeInfoEdit.storeInfo.tel),
                    this.storeInfoEdit.businessNum.length === 8
                ];
                CheckItem.editError = checksError.some(check => check === false);

                // 檢查是否有變動
                const checksEdit = [
                    this.StoreInfoCheck_address(),
                    this.StoreInfoCheck_email(),
                    this.StoreInfoCheck_tel(),
                    this.StoreInfoCheck_introduction(),
                    this.StoreInfoCheck_businessNum()
                ];
                CheckItem.editDone = checksEdit.some(check => check === true);

                return CheckItem.editDone; // 確保回傳布林值
            },

            //-------大區塊：營業時間-------
            BusinessTime() {
                const CheckItem = this.StoreEditItem.find(item => item.id === 'BusinessTime');

                //是否有完成編輯
                const checksEdit = [this.BussinessTime_check()]
                CheckItem.editDone = checksEdit.some(check => check === true);
                return CheckItem.editDone
            },

            //-------大區塊：營業等待時間-------
            WaitingTime() {
                const CheckItem = this.StoreEditItem.find(item => item.id === 'WaitingTime');

                //未錯誤條件
                const checksError = [this.validateIntervalTime(this.storeInfoEdit.intervalwaitingTime, 5)]
                CheckItem.editError = checksError.some(check => check === false)

                //是否有完成編輯
                const checksEdit = [this.WaitingTime_basic(), this.WaitingTime_interval()]
                CheckItem.editDone = checksEdit.some(check => check === true);

                return CheckItem.editDone
            },

            //-------大區塊：低消提醒-------
            minimumOrderReminder() {
                const CheckItem = this.StoreEditItem.find(item => item.id === 'ReminderToggle');

                //是否有完成編輯
                const checksEdit = [this.minimumOrderReminder_check()]
                CheckItem.editDone = checksEdit.some(check => check === true);
                return CheckItem.editDone
            },

            //-------大區塊：特定店休-------
            storeClosed() {
                const CheckItem = this.StoreEditItem.find(item => item.id === 'StoreClosed');

                //是否有完成編輯
                const checksEdit = [this.storeClosed_check()]
                CheckItem.editDone = checksEdit.some(check => check === true);

                return CheckItem.editDone
            },

            //-------大區塊：可預訂天數-------
            advanceReservation() {
                const CheckItem = this.StoreEditItem.find(item => item.id === 'AdvanceReservation');
                //是否有完成編輯
                const checksEdit = [this.advanceReservation_check()]
                CheckItem.editDone = checksEdit.some(check => check === true);
                return CheckItem.editDone
            },


            //其他單筆資訊是否完成編輯（可不可為空值 / 是否有被編輯 / 是否符合格式）：完成：true/不算完成：false
            //店家資訊：店家地址
            StoreInfoCheck_address() {
                return JSON.stringify(this.storeInfoEdit.address) !== JSON.stringify(this.storeInfo.address);
            },

            //店家資訊：店家信箱
            StoreInfoCheck_email() {
                //非空值且有被編輯後才去比對格式
                if (this.storeInfoEdit.email != '' && this.storeInfoEdit.email !== this.storeInfo.email && this.validateEmail(this.storeInfoEdit.email)) {
                    return true//符合:false
                } else {
                    return false
                }
            },

            //店家資訊：店家電話
            StoreInfoCheck_tel() {
                //非空值且有被編輯後才去比對格式
                if (this.storeInfoEdit.storeInfo.tel != '' && this.storeInfoEdit.storeInfo.tel !== this.storeInfoEdit.storeInfo.tel && this.validateTalAndPhone(this.storeInfoEdit.storeInfo.tel)) {
                    return true//符合:false
                } else {
                    return false
                }
            },

            //店家資訊：店家簡介
            StoreInfoCheck_introduction() {
                return this.storeInfoEdit.introduction !== this.storeInfo.introduction;
            },

            //店家資訊：店家統編
            StoreInfoCheck_businessNum() {
                if (this.storeInfoEdit.businessNum != '' && this.storeInfoEdit.businessNum !== this.storeInfo.businessNum && this.storeInfoEdit.businessNum.length == 8) {
                    return true//符合:false
                } else {
                    return false
                }
            },

            //營業時間整體
            BussinessTime_check() {
                if (JSON.stringify(this.storeInfoEdit.businessDays) !== JSON.stringify(this.storeInfo.businessDays)) {
                    return true//符合:false
                } else {
                    return false
                }
            },

            //營業等待時間：基礎時間
            WaitingTime_basic() {
                if (JSON.stringify(this.storeInfoEdit.basicwaitingTime) !== JSON.stringify(this.storeInfo.basicwaitingTime)) {
                    return true//符合:false
                } else {
                    return false
                }
            },

            //營業等待時間：間隔時間
            WaitingTime_interval() {
                if (this.storeInfoEdit.intervalwaitingTime != '' &&
                    this.storeInfoEdit.intervalwaitingTime != this.storeInfo.intervalwaitingTime &&
                    this.storeInfoEdit.intervalwaitingTime % 5 === 0) {
                    return true//符合:false
                } else {
                    return false
                }
            },

            // 低消提醒整體
            minimumOrderReminder_check() {
                if (JSON.stringify(this.storeInfoEdit.minimumOrderReminder) !== JSON.stringify(this.storeInfo.minimumOrderReminder)) {
                    return true//符合:false
                } else {
                    return false
                }
            },

            // 特定店休整體
            storeClosed_check() {
                if (JSON.stringify(this.storeInfoEdit.openTime.specialCloseDays) !== JSON.stringify(this.storeInfoEdit.openTime.specialCloseDays)) {
                    return true//符合:false
                } else {
                    return false
                }
            },

            // 可預訂天數整體
            advanceReservation_check() {
                if (JSON.stringify(this.storeInfoEdit.advanceReservation) !== JSON.stringify(this.storeInfo.advanceReservation)) {
                    return true//符合:false
                } else {
                    return false
                }
            },

            // 處理圖片上傳
            handleFileUpload_banner(event) {
                this.imageAction = 'banner'
                var vue = this
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        this.imageUrl = e.target.result;

                        // 確保 Modal 開啟後再初始化 Cropper
                        $("#ProductorEdit").modal("hide");
                        setTimeout(() => {
                            $("#cropModal").modal("show");
                            setTimeout(() => {
                                vue.initCropper_banner();
                            }, 300);
                        }, 500);
                    };
                    reader.readAsDataURL(file);
                }
            },
            // 初始化 Cropper.js
            initCropper_banner() {
                var vue = this
                if (this.cropper) {
                    this.cropper.destroy();
                }
                this.$nextTick(() => {
                    const image = this.$refs.image;
                    image.onload = () => {
                        this.cropper = new Cropper(image, {
                            aspectRatio: 16 / 9,   // 1:1 比例
                            viewMode: 2,      // 限制裁剪框不超出圖片範圍
                            autoCropArea: 1,  // 預設裁剪範圍最大
                            minCropBoxWidth: vue.BannerImageSize.w,
                            minCropBoxHeight: vue.BannerImageSize.h,
                            ready: () => {
                                this.cropper.setCropBoxData({ width: vue.BannerImageSize.w, height: vue.BannerImageSize.h });
                            },
                            rotatable: false, // 禁止旋轉
                            scalable: false,  // 禁止縮放
                            zoomable: false,  // 禁止縮放
                            movable: false,   // 禁止移動圖片
                            checkOrientation: false // 禁止自動旋轉
                        });
                    };
                    image.src = this.imageUrl;
                });
            },
            // 裁剪圖片並轉 Base64
            cropImage_banner() {
                var vue = this
                if (this.cropper) {
                    const canvas = this.cropper.getCroppedCanvas({
                        width: vue.BannerImageSize.w,
                        height: vue.BannerImageSize.h
                    });
                    this.croppedImage = canvas.toDataURL("image/png");


                    this.storeInfoEdit.store.bannerimage = this.croppedImage
                    // console.log(this.storeInfoEdit.storeInfo.bannerimage);

                    $("#cropModal").modal("hide");
                    $("#ProductorEdit").modal("show");
                }
            },



            // 處理圖片上傳
            handleFileUpload_logo(event) {
                this.imageAction = 'logo'
                var vue = this
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        this.imageUrl = e.target.result;

                        // 確保 Modal 開啟後再初始化 Cropper
                        $("#ProductorEdit").modal("hide");
                        setTimeout(() => {
                            $("#cropModal").modal("show");
                            setTimeout(() => {
                                vue.initCropper_logo();
                            }, 300);
                        }, 500);
                    };
                    reader.readAsDataURL(file);
                }
            },
            // 初始化 Cropper.js
            initCropper_logo() {
                var vue = this
                if (this.cropper) {
                    this.cropper.destroy();
                }
                this.$nextTick(() => {
                    const image = this.$refs.image;
                    image.onload = () => {
                        this.cropper = new Cropper(image, {
                            aspectRatio: 1,   // 1:1 比例
                            viewMode: 2,      // 限制裁剪框不超出圖片範圍
                            autoCropArea: 1,  // 預設裁剪範圍最大
                            minCropBoxWidth: vue.LogoImageSize.w,
                            minCropBoxHeight: vue.LogoImageSize.h,
                            ready: () => {
                                this.cropper.setCropBoxData({ width: vue.LogoImageSize.w, height: vue.LogoImageSize.h });
                            },
                            rotatable: false, // 禁止旋轉
                            scalable: false,  // 禁止縮放
                            zoomable: false,  // 禁止縮放
                            movable: false,   // 禁止移動圖片
                            checkOrientation: false // 禁止自動旋轉
                        });
                    };
                    image.src = this.imageUrl;
                });
            },
            // 裁剪圖片並轉 Base64
            cropImage_logo() {
                var vue = this
                if (this.cropper) {
                    const canvas = this.cropper.getCroppedCanvas({
                        width: vue.LogoImageSize.w,
                        height: vue.LogoImageSize.h
                    });
                    this.croppedImage = canvas.toDataURL("image/png");

                    // console.log(this.croppedImage);
                    this.storeInfoEdit.store.image = this.croppedImage


                    $("#cropModal").modal("hide");
                    $("#ProductorEdit").modal("show");
                }
            }

        },
        computed: {
            today() {
                return moment().format('YYYY-MM-DD');
            }
        }
    });
    app.mount("#app");
</script>
<style>
    /* 修正裁剪區域異常的問題 */
    .img-container {
        width: 100%;
        max-height: 500px;
        overflow: hidden;
    }

    /* 增加 modal-xl 讓裁剪區域更大 */
    .modal-xl {
        max-width: 90vw;
    }

    /* 確保裁剪圖片可以完整顯示 */
    #image {
        display: block;
        max-width: 100%;
        height: auto;
    }
</style>

</html>