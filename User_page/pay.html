<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>結帳</title>

  <!-- jquery -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>

  <!-- JavaScript Bundle with Popper -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.bundle.min.js"></script>
  <!-- <link rel="stylesheet" href="css/bootstrap.min.css"> -->

  <!-- fontawesome -->
  <script src="https://kit.fontawesome.com/4de7eaf6aa.js" crossorigin="anonymous"></script>

  <!-- Theme style -->
  <link rel="stylesheet" href="AdminLTE3/dist/css/adminlte.min.css">
  <script src="AdminLTE3/dist/js/adminlte.min.js"></script>

  <!-- Chart.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.3/Chart.bundle.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.3/Chart.min.css" />

  <!-- toastr -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.css" />

  <!-- datepicker -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.30.1/moment.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.css" />

  <!-- Vue.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/vue/3.5.13/vue.global.min.js"></script>

  <script src="js/share2.js"></script>
  <link rel="stylesheet" href="css/share2.css" />

  <!-- Swiper -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Swiper/11.0.5/swiper-bundle.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Swiper/11.0.5/swiper-bundle.min.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
</head>

<body class="hold-transition sidebar-collapse layout-top-nav layout-footer-fixed">
  <div class="preloader flex-column justify-content-center align-items-center">
    <img class="animation__shake" src="img/logo.svg" style="height: 15vh;">
  </div>
  <div class="wrapper" id="app">
    <nav class="main-header navbar navbar-expand-md navbar-light navbar-white">
      <div class="container">
        <a class="toIndex navbar-brand">
          <img src="img/logo2.svg" alt="AdminLTE Logo" class="" style="width: 200px;">
        </a>

        <!-- <button class="navbar-toggler order-1" type="button" data-toggle="collapse"
                    data-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false"
                    aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button> -->

        <!-- <div class="collapse navbar-collapse order-3" id="navbarCollapse">
                    <ul class="navbar-nav">
                        <li class="nav-item">
                            <a class="nav-link" data-widget="pushmenu" href="#" role="button"><i
                                    class="fas fa-bars"></i></a>
                        </li>
                        <li class="nav-item">
                            <a href="index3.html" class="nav-link">Home</a>
                        </li>
                        <li class="nav-item">
                            <a href="#" class="nav-link">Contact</a>
                        </li>
                        <li class="nav-item dropdown">
                            <a id="dropdownSubMenu1" href="#" data-toggle="dropdown" aria-haspopup="true"
                                aria-expanded="false" class="nav-link dropdown-toggle">Dropdown</a>
                            <ul aria-labelledby="dropdownSubMenu1" class="dropdown-menu border-0 shadow">
                                <li><a href="#" class="dropdown-item">Some action </a></li>
                                <li><a href="#" class="dropdown-item">Some other action</a></li>

                                <li class="dropdown-divider"></li>

                <li class="dropdown-submenu dropdown-hover">
                    <a id="dropdownSubMenu2" href="#" role="button" data-toggle="dropdown" aria-haspopup="true"
                        aria-expanded="false" class="dropdown-item dropdown-toggle">Hover for action</a>
                    <ul aria-labelledby="dropdownSubMenu2" class="dropdown-menu border-0 shadow">
                        <li>
                            <a tabindex="-1" href="#" class="dropdown-item">level 2</a>
                        </li>

                        <li class="dropdown-submenu">
                            <a id="dropdownSubMenu3" href="#" role="button" data-toggle="dropdown" aria-haspopup="true"
                                aria-expanded="false" class="dropdown-item dropdown-toggle">level 2</a>
                            <ul aria-labelledby="dropdownSubMenu3" class="dropdown-menu border-0 shadow">
                                <li><a href="#" class="dropdown-item">3rd level</a></li>
                                <li><a href="#" class="dropdown-item">3rd level</a></li>
                            </ul>
                        </li>

                        <li><a href="#" class="dropdown-item">level 2</a></li>
                        <li><a href="#" class="dropdown-item">level 2</a></li>
                    </ul>
                </li>
                </ul>
                </li>
                </ul>

            </div> -->


        <ul class="order-1 order-md-3 navbar-nav navbar-no-expand ml-auto">
          <!-- <li class="nav-item">
            <a class="nav-link toCart" data-toggle="dropdown">
              <i class="fas fa-shopping-cart"></i>
              <span class="badge badge-primary navbar-badge">3</span>
            </a>
          </li> -->
          <li class="nav-item dropdown">
            <a class="nav-link" data-toggle="dropdown" href="#">
              <i class="fas fa-user"></i>
            </a>
            <div class="dropdown-menu dropdown-menu-lg dropdown-menu-right">
              <span class="dropdown-header">使用者功能</span>
              <div class="dropdown-divider"></div>
              <div v-for="(func,index) in userFunction">
                <a :href="func.url" class="dropdown-item">
                  {{func.name}}
                  <span class="float-right text-muted text-sm">
                    <i :class="func.icon"></i>
                  </span>
                </a>
                <div class="dropdown-divider"></div>
              </div>
            </div>
          </li>
        </ul>
      </div>
    </nav>

    <div class="content-wrapper">
      <div class="content-header">
        <div class="container">
          <div class="row mb-2">
            <div class="col-sm-6">
              <h1 class="m-0">{{PageTitle}}</h1>
              <p class="m-0 text-muted">
                <i class="fas fa-map-marker-alt mr-2 text-secondary"></i>
                {{storeInfo.storeInfo.city}}
                {{storeInfo.storeInfo.districts}}
                {{storeInfo.storeInfo.shortAddress}}
              </p>
            </div>
            <!-- <div class="col-sm-6">
              <ol class="breadcrumb float-sm-right">
                <li class="breadcrumb-item"><a class="toIndex">SHARING</a></li>
                <li class="breadcrumb-item">{{PageTitle}}</li>
              </ol>
            </div> -->
          </div>
        </div>
      </div>
      <div class="content">
        <div class="container">
          <div class="row">

            <div class="col-12 col-md-8 p-3 itemOnlyHover">
              <h6 class="m-0">
                <span class="text-primary mr-2">
                  <i class="fas fa-clock"></i>
                </span>
                <label for="IsTableware" class="m-0">取餐時間</label>
              </h6>
              <div class="row m-0 pl-4">
                <select v-model="takeTime.type" class="form-control form-control-sm col-4 mr-3">
                  <option value="0">現在</option>
                  <option value="1">預定</option>
                </select>
                <!-- <input type="date" class="form-control col" v-show="takeTime.type==1">
                <input type="time" class="form-control col" v-show="takeTime.type==1"> -->
                <input class="form-control datetimelocal form-control-sm col" :disabled="takeTime.type != 1"
                  :value="takeTime.datetime" placeholder="YYYY-MM-DD HH:mm">
              </div>

            </div>

            <div class="col-12 col-md-8 p-3 itemOnlyHover">
              <h6 class="m-0">
                <span class="text-primary mr-2"><i class="fas fa-utensils"></i></span>
                <label for="IsTableware" class="m-0">需要餐具</label>
                <input type="checkbox" class="float-right" id="IsTableware" v-model="toPayData.IsTableware">
                <span class="float-right text-muted text-sm mr-2" v-show="toPayData.IsTableware">為了地球環保請盡量使用環保餐具</span>
              </h6>
            </div>

            <div class="col-12 col-md-8 p-3 itemOnlyHover">
              <h6 class="m-0">
                <span class="text-primary mr-2"><i class="fas fa-shopping-bag"></i></span>
                <label for="IsPlacetic" class="m-0">需要塑膠袋</label>
                <input type="checkbox" class="float-right" id="IsPlacetic" v-model="toPayData.IsPlacetic">
                <span class="float-right text-muted text-sm mr-2" v-show="toPayData.IsPlacetic">+ $2</span>
              </h6>
            </div>

            <div class="col-12 col-md-8 p-3">
              <h6 class="m-0">
                <span class="text-primary mr-2"><i class="fas fa-receipt"></i></span>
                訂單內容（{{cartCount}}）
              </h6>
              <div class="item border-bottom p-3" v-for="(item,index) in cartList">
                <p class="text-bold m-0">{{item.mealName}} <span
                    class="float-right text-primary">${{item.totalPrice}}</span></p>
                <p class="text-muted m-0 text-xs">
                  <span v-if="item.mealConfig.options[0].value.length>0">{{item.mealConfig.options[0].value}},</span>
                  <template v-for="(option,opIndex) in item.customConfig[0].options">
                    <span v-for="(select,selectIndex) in option.content">{{select.title}}(+{{select.extra}}),</span>
                  </template>
                </p>
              </div>
              <div class="item p-3">
                <h6 class="m-0">總金額<span class="text-primary float-right">${{getTotalPrice}}</span></h6>

              </div>
            </div>

            <div class="col-12 col-md-8 p-3 itemOnlyHover">
              <h6 class="m-0">
                <span class="text-primary mr-2"><i class="fas fa-user-circle"></i></span>
                <label for="UserInfo" class="m-0">訂購人資訊</label>
                <input type="checkbox" class="float-right" id="UserInfo" v-model="userInfoSync">
                <span class="float-right text-muted text-sm mr-2">同此帳號資料</span>
              </h6>
              <div class="m-0 pl-4">
                <div class="form-group p-0">
                  <label class="text-muted text-sm">名稱</label>
                  <input class="form-control form-control-sm" :disabled="userInfoSync" v-model="toPayData.UserName
                  ">
                </div>
                <div class="form-group p-0">
                  <label class="text-muted text-sm">手機號碼</label>
                  <input class="form-control form-control-sm" :disabled="userInfoSync" v-model="toPayData.UserPhoneNum">
                </div>
              </div>
            </div>

            <div class="col-12 col-md-8 p-3">
              <h6 class="m-0">
                <span class="text-primary mr-2"><i class="fas fa-money-check-alt"></i></span>
                <label for="UserInfo" class="m-0">付款方式</label>
              </h6>
              <div class="item p-3 row" v-for="(item,index) in PaymentMethodsList"
                :class="{ 'disabled': !item.enabled }">
                <input type="radio" :value="item.value" :id="'PaymentMethods_' + item.value" name="PaymentMethods"
                  v-model="toPayData.PaymentMethods">
                <label :for="'PaymentMethods_'+item.value" class="m-0 col">{{item.name}}</label>
              </div>
            </div>

            <div class="col-12 col-md-8 p-3 itemOnlyHover" v-if="cartList.length>0">
              <h6 class="m-0">
                <span class="text-primary"><i class="fas fa-comment-dots"></i></span>
                備註
              </h6>
              <div class="p-3">
                <textarea class="form-control" maxlength="50"></textarea>
              </div>
            </div>

            <div class="col-12 col-md-8 py-5" v-if="cartList.length>0">
              <div class="btn btn-block btn-primary" @click="Pay">確認送出</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <footer class="main-footer">
      <span class="float-right d-none d-sm-inline" id="version"></span>
      <!-- Default to the left -->
      <strong id="copyRight"></strong>
    </footer>
  </div>

</body>

<script>
  const app = Vue.createApp({
    data() {
      return {
        userFunction: userFunction,

        PageTitle: '',

        //原始資料
        userInfo: decryptObject(localStorage.userInfo),
        storeInfo: {
          "store": {
            "storeId": "",
            "storeName": "",
            "storePhone": "",
            "minOrderAmount": 0,
            "orderInterval": 0,
            "createdDate": "",
            "enable": true,
            "deleted": false,
            "id": 0,
            "slotLimit": 0,
            "amountLimit": 0
          },
          "storeInfo": {
            "storeId": "",
            "city": "",
            "districts": "",
            "shortAddress": "",
            "email": "",
            "tel": "",
            "businessNum": "",
            "introduction": "",
            "tags": [],
            "basicwaitingTime": "",
            "minimumOrderAmount": "",
            "minimumOrderText": "",
            "minimumOrderEnabled": true,
            "maxReservationDays": 0
          },
          "openTime": {
            "businessDays": [
              {
                "id": "",
                "title": "",
                "operation": true,
                "time": [
                  {
                    "open": "00:00",
                    "close": "00:00"
                  }
                ]
              },
            ],
            "specialCloseDays": [
              {
                "title": "",
                "date": ""
              },
            ]
          },
          "status": {
            "storeId": "",
            "isOpen": false,
            "closedReason": "",
            "lastUpdated": ""
          },
          "activeMenu": {
            "menuId": "",
            "menuName": "",
            "isActive": true,
            "createdDate": "",
            "itemCount": 0
          },
          "nextAvailable": {
            "time": "",
            "timeFormatted": ""
          }
        },

        cartList: localStorage.cart ? JSON.parse(localStorage.cart) : '',

        cartCount: 0,

        toPayData: {
          "MemberId": '',
          "StoreId": '',
          // "Price": 100,
          // "Discount": 0,
          UserName: '',
          UserPhoneNum: '',
          "Menu": "",
          "IsTableware": false,
          "IsOnlyPrice": false, //只想要取得目前訂單價格
          "PaymentMethods": "cash",
          "appointmentDate": "", //日期
          "appointmentTime": "" //時間
        },

        takeTime: {
          type: 0, //0現在，1預定
          datetime: moment().format('YYYY-MM-DD HH:mm:ss')
        },

        userInfoSync: true,

        PaymentMethodsList: [
          {
            name: '現金',
            value: 'cash',
            enabled: true
          },
          // {
          //   name: 'LINE PAY',
          //   value: 'linepay',
          //   enabled: false
          // }
        ]

      }
    },
    mounted() {

      // console.log(this.carstList);

      console.log(this.userInfo);


      this.cartCount = this.cartList.length

      let vue = this
      apiWeb('/api/Store/detail/' + this.cartList[0].storeId, 'GET', null, '店家資訊', function (v) {

        vue.PageTitle = v.store.storeName
        vue.storeInfo = v

        vue.toPayData.UserName = vue.userInfo.name
        vue.toPayData.UserPhoneNum = vue.userInfo.phoneNum

        // console.log(vue.toPayData);


        loadingOff()

      });


    },
    watch: {
      'takeTime.type'(val) {
        if (val == 0) {
          // 如果選擇「現在」，就自動填入現在時間
          this.takeTime.datetime = moment().format('YYYY-MM-DD HH:mm:ss');
        } else if (val == 1) {
          // 如果是預約，保留目前 datetime（或清空）
          // this.takeTime.datetime = '';
        }

        // 只有在預約時初始化日期選擇器
        if (val == 1) {
          this.$nextTick(() => {
            const $input = $('.datetimelocal');

            // 移除先前已經初始化的 daterangepicker，避免重複綁定
            if ($input.data('daterangepicker')) {
              $input.data('daterangepicker').remove();
            }

            // 初始化日期時間選擇器
            $input.daterangepicker({
              singleDatePicker: true,
              timePicker: true,
              timePicker24Hour: true,
              autoApply: true,
              autoUpdateInput: true,
              startDate: moment(this.takeTime.datetime),
              minDate: moment(),
              maxDate: moment().add(this.storeInfo.storeInfo.maxReservationDays, 'days'),
              locale: {
                format: 'YYYY-MM-DD HH:mm:ss',
                firstDay: 0
              }
            }).on('apply.daterangepicker', (ev, picker) => {
              this.takeTime.datetime = picker.startDate.format('YYYY-MM-DD HH:mm:ss');
            });
          });
        }
      }
    },

    methods: {
      Pay() {
        loadingOn()
        const m = moment(this.takeTime.datetime, "YYYY-MM-DD HH:mm:ss");
        const datePart = m.format("YYYY-MM-DD");
        const timePart = m.format("HH:mm:ss");

        this.toPayData.MemberId = this.userInfo.id
        this.toPayData.StoreId = this.cartList[0].storeId
        this.toPayData.Menu = JSON.stringify(this.cartList)
        this.toPayData.IsOnlyPrice = false //只想要取得目前訂單價格
        this.toPayData.PaymentMethods = "cash"
        this.toPayData.appointmentDate = datePart //日期
        this.toPayData.appointmentTime = timePart //時間

        console.log(this.toPayData);
        apiWeb('/api/store/send/order', 'POST', JSON.stringify(this.toPayData), '送出訂單',
          function () {
            window.location.href = "succes.html"
          })

      }
    },
    computed: {
      getTotalPrice() {
        let vue = this
        let totalPrice = total = vue.cartList.reduce((sum, meal) => {
          return sum + Number(meal.totalPrice);
        }, 0);
        if (vue.toPayData.IsPlacetic == true) {
          return totalPrice + 2
        } else {
          return totalPrice
        }
      }
    }
  });
  app.mount("#app");
</script>

</html>