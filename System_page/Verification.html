<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>共響 SHARING｜後台管理系統</title>

    <!-- jquery -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>

    <!-- JavaScript Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.bundle.min.js"></script>
    <!-- <link rel="stylesheet" href="css/bootstrap.min.css"> -->

    <!-- fontawesome -->
    <script src="https://kit.fontawesome.com/4de7eaf6aa.js" crossorigin="anonymous"></script>

    <!-- Theme style -->
    <link rel="stylesheet" href="AdminLTE3/dist/css/adminlte.min.css">
    <script src="AdminLTE3/dist/js/adminlte.min.js"></script>

    <!-- Chart.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.3/Chart.bundle.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.3/Chart.min.css" />

    <!-- toastr -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.css" />

    <!-- datepicker -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.30.1/moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.css" />

    <!-- Vue.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vue/3.5.13/vue.global.min.js"></script>

    <script src="js/share.js?v101"></script>
    <link rel="stylesheet" href="css/share.css?v101" />

    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>

</head>

<body class="login-page iframe-mode" style="height: 100%;">
    <!-- Preloader -->
    <div class="preloader flex-column justify-content-center align-items-center">
        <img class="animation__shake" src="img/logo.svg" style="height: 15vh;">
    </div>
    <!--  <div class="modal fade" id="storeModal" tabindex="-1" data-backdrop="static" data-keyboard="false" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
      <div class="modal-header">
          <h5 class="modal-title" id="exampleModalLabel">Modal title</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <h3></h3>
        </div>
       <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
          <button type="button" class="btn btn-primary">Save changes</button>
        </div>
      </div>
    </div>
  </div> -->
    <div class="login-box" id="app">

        <div class="card">
            <div class="card-body login-card-body p-4">
                <h4 class="mb-4">請輸入OTP密碼</h4>
                <form @submit.prevent="login">
                    <div class="d-flex" style="gap: 10px;">
                        <input v-for="(digit, index) in digits" :key="index" class="form-control text-center"
                            maxlength="1" type="text" inputmode="numeric" pattern="[0-9]*" ref="inputs"
                            v-model="digits[index]" @input="handleInput(index, $event)"
                            @keydown.backspace="handleBackspace(index, $event)" />
                    </div>
                </form>
                <div class="text-memo text-danger formHint mt-3" v-if="errorMsg">{{ errorMsg }}</div>
            </div>
            <!-- /.login-card-body -->
        </div>

    </div>
</body>
<script>
    const app = Vue.createApp({
        data() {
            return {
                digits: ['', '', '', '', '', ''],
                errorMsg: ''
            }
        },
        mounted() {
            loadingOff();
        },
        methods: {
            handleInput(index, event) {
                const value = event.target.value.replace(/\D/g, '')
                this.digits[index] = value;

                if (value && index < this.digits.length - 1) {
                    this.$refs.inputs[index + 1].focus();
                }

                if (this.digits.every(d => d !== '')) {
                    this.login();
                }
            },
            handleBackspace(index, event) {
                if (event.target.value === '' && index > 0) {
                    this.$refs.inputs[index - 1].focus();
                }
            },
            async login() {
                this.errorMsg = '';
                loadingOn();
                const code = this.digits.join('');

                // 取登入階段的臨時token或userId
                const tempToken = localStorage.getItem('tempToken') || '';
                const fallbackUserId = localStorage.getItem('twoFactorUserId') || '';
                const userIdForVerify = tempToken || fallbackUserId;

                if (!userIdForVerify) {
                    loadingOff();
                    this.errorMsg = '驗證流程已失效，請重新登入';
                    setTimeout(() => (window.location.href = 'login.html'), 800);
                    return;
                }

                try {
                    // 先以 AutoKey 取得授權 Token
                    const keyRes = await fetch(`${host}api/auth/keylogin`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ key: AutoKey })
                    });
                    const keyData = await keyRes.json().catch(() => ({}));
                    const authHeader = keyRes.ok && keyData.token ? `Bearer ${keyData.token}` : '';

                    const res = await fetch(`${host}api/twofactor/verify`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', ...(authHeader ? { Authorization: authHeader } : {}) },
                        body: JSON.stringify({ userId: userIdForVerify, code })
                    });

                    const data = await res.json().catch(() => ({}));

                    if (!res.ok) {
                        const attempts = parseInt(localStorage.getItem('verifyAttempts') || '0', 10) + 1;
                        localStorage.setItem('verifyAttempts', String(attempts));

                        const msg = data.message || data.Message || '驗證失敗，請再試一次';
                        if (attempts >= 3) {
                            localStorage.setItem('loginError', '登入失敗');
                            localStorage.removeItem('tempToken');
                            localStorage.removeItem('twoFactorUserId');
                            localStorage.removeItem('verifyAttempts');
                            window.location.href = 'login.html';
                            return;
                        }

                        this.errorMsg = `${msg}（剩餘嘗試次數：${3 - attempts}）`;
                        loadingOff();
                        return;
                    }

                    // 成功：寫入用戶資訊並進入系統
                    const encryptedId = data.encryptedId ?? data.EncryptedId;
                    const userData = data.userData ?? data.UserData;
                    const username = data.username ?? data.Username;
                    const roles = data.roles ?? data.Roles;

                    if (encryptedId) localStorage.setItem('userToken', encryptedId);
                    if (userData) localStorage.setItem('userData', JSON.stringify(userData));
                    if (username) localStorage.setItem('username', username);
                    if (roles) localStorage.setItem('roles', roles);

                    // 清理臨時狀態
                    localStorage.removeItem('tempToken');
                    localStorage.removeItem('twoFactorUserId');
                    localStorage.removeItem('verifyAttempts');

                    window.location.href = 'account_System.html';
                } catch (e) {
                    this.errorMsg = '系統繁忙，請稍後再試';
                } finally {
                    loadingOff();
                }
            },
        },
    });
    app.mount("#app");
</script>

</html>