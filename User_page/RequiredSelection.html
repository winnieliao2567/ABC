<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>必選專區｜SHARING</title>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.bundle.min.js"></script>
	<link rel="stylesheet" href="AdminLTE3/dist/css/adminlte.min.css">
	<script src="AdminLTE3/dist/js/adminlte.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.css" />
	<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.30.1/moment.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/vue/3.5.13/vue.global.min.js"></script>
	<script src="js/share2.js?v101"></script>
	<link rel="stylesheet" href="css/share2.css" />
</head>
<body class="hold-transition layout-top-nav">
	<div class="preloader flex-column justify-content-center align-items-center">
		<img class="animation__shake" src="img/logo.svg" style="height: 15vh;">
	</div>
	<div id="app" class="wrapper">
		<nav class="main-header navbar navbar-expand-md navbar-light navbar-white">
			<div class="container">
				<a class="navbar-brand"><img src="img/logo2.svg" style="width: 160px;"></a>
				<h5 class="m-0 ml-3">必選專區</h5>
			</div>
		</nav>
		<div class="content-wrapper">
			<section class="content">
				<div class="container py-3">
					<div v-if="groups.length===0" class="text-center text-muted py-5">沒有需要必選的項目</div>
					<div v-for="(group, gi) in groups" :key="gi" class="card mb-3">
						<div class="card-header d-flex justify-content-between align-items-center">
							<h5 class="m-0">{{group.name || group.templateName || group.TemplateName}}</h5>
							<small class="text-primary" v-if="group.required">必選 <span v-if="group.minChoices">（至少選 {{group.minChoices}} 項）</span></small>
						</div>
						<div class="card-body">
							<div class="row">
								<div class="col-12 col-md-6 mb-2" v-for="(opt, oi) in (group.items || group.options || [])" :key="oi">
									<div class="border rounded p-2 d-flex justify-content-between align-items-center"
										:class="{'bg-light': isSelected(gi, opt)}"
										@click="toggleSelect(gi, opt)">
										<span>{{opt.title}}</span>
										<span class="text-primary" v-if="opt.extra && opt.extra !== 0">
											{{opt.extra > 0 ? '+' : ''}}${{opt.extra}}
										</span>
									</div>
								</div>
							</div>
						</div>
					</div>
					<div class="text-right">
						<button class="btn btn-secondary mr-2" @click="cancel">取消返回</button>
						<button class="btn btn-primary" :disabled="!canSubmit" @click="submit">確認選擇</button>
					</div>
				</div>
			</section>
		</div>
		<footer class="main-footer"><span id="version"></span></footer>
	</div>
	<script>
	const app = Vue.createApp({
		data(){
			return {
				groups: [],
				selections: {}, // gi -> Set(option.title)
				storeId: new URLSearchParams(location.search).get('sid') || localStorage.getItem('pendingRequiredForStore') || ''
			}
		},
		computed:{
			canSubmit(){
				for(const [i, g] of this.groups.entries()){
					if(g.required){
						const set = this.selections[i] || new Set()
						const min = Number(g.minChoices || 1)
						if(set.size < min) return false
					}
				}
				return true
			}
		},
		mounted(){
			loadingOff()
			
			// 清除之前的選擇結果，確保每次都是全新選擇
			this.selections = {}
			localStorage.removeItem('requiredSelections')

			
			try{
				const cache = localStorage.getItem('requiredTemplatesCache')
				if (cache) {
					let parsedCache = JSON.parse(cache)
					
					// 處理不同的數據結構
					if (parsedCache && typeof parsedCache === 'object') {
						// 如果是模板對象，提取群組
						if (parsedCache.groups) {
							this.groups = parsedCache.groups
						} else if (parsedCache.Groups) {
							this.groups = parsedCache.Groups
						} else if (Array.isArray(parsedCache)) {
							// 如果直接是數組
							this.groups = parsedCache
						} else {
							// 如果是其他對象結構，尋找群組屬性
							const possibleGroups = ['groups', 'Groups', 'items', 'Items', 'templates', 'Templates']
							for (const prop of possibleGroups) {
								if (parsedCache[prop] && Array.isArray(parsedCache[prop])) {
									this.groups = parsedCache[prop]
									break
								}
							}
						}
					}
					

				}
				
				// 如果沒有群組，顯示調試信息
				if (!this.groups || this.groups.length === 0) {

				}
			} catch(e){ 
				console.error('解析必選模板失敗:', e)
				this.groups = [] 
			}
		},
		methods:{
			isSelected(gi, opt){
				const set = this.selections[gi] || new Set()
				return set.has(opt.title)
			},
			toggleSelect(gi, opt){
				if(!this.selections[gi]) this.selections[gi] = new Set()
				const set = this.selections[gi]
				// 檢查是否為多選類型 (type 可能是 "multi", 1, "1" 等格式)
				const isMulti = (
					this.groups[gi].type === 'multi' || 
					this.groups[gi].type === 1 || 
					this.groups[gi].Type === 1 ||
					this.groups[gi].type === "1"
				)
				

				
				if(isMulti){
					// 多選：切換選項
					if(set.has(opt.title)) set.delete(opt.title); else set.add(opt.title)
				}else{
					// 單選：清除其他選項，只保留當前選項
					this.selections[gi] = new Set([opt.title])
				}
				this.selections = { ...this.selections }
			},
			submit(){
				// 轉換選擇結果為必選項目格式
				const requiredSelections = []
				
				Object.keys(this.selections).forEach(groupIndex => {
					const group = this.groups[parseInt(groupIndex)]
					const selectedTitles = Array.from(this.selections[groupIndex])
					
					selectedTitles.forEach(title => {
						// 找到對應的選項以獲取額外價格
						const option = (group.items || group.options || []).find(opt => opt.title === title)
						
						requiredSelections.push({
							group: group.name || group.templateName || group.TemplateName || `群組${groupIndex}`,
							title: title,
							extra: option ? (option.extra || 0) : 0
						})
					})
				})
				

				
				// 儲存到 localStorage 供 pay.html 使用
				localStorage.setItem('requiredSelections', JSON.stringify(requiredSelections))
				
				// 直接跳轉到結帳頁面
				window.location.href = 'pay.html?sid=' + this.storeId
			},
			cancel(){
				// 清除暫存數據
				localStorage.removeItem('requiredSelections')
				localStorage.removeItem('requiredTemplatesCache')
				
				// 返回購物車頁面
				window.location.href = 'cart.html?sid=' + this.storeId
			}
		}
	})
	app.mount('#app')
	</script>
</body>
</html> 